<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Working with DynamoDB</title><meta property="og:title" content="Working with DynamoDB"><meta name=twitter:title content="Working with DynamoDB"><meta name=author content><meta property="og:site_name" content="akarasz.me"><meta property="og:url" content="https://akarasz.me/2021/03/working-with-dynamodb/"><meta name=twitter:card content="summary"><meta property="og:type" content="article"><meta name=generator content="Hugo 0.81.0"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-34856109-2','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=stylesheet href=https://akarasz.me/css/style.css><script type=text/javascript src=https://akarasz.me/js/bundle.js></script></head><body><a href=#main class="skip-link p-screen-reader-text">Skip to content</a><svg xmlns="http://www.w3.org/2000/svg" style="display:none" aria-hidden="true"><symbol id="icon-500px" viewBox="0 0 16 16"><g><path d="M3.953 10.512a5.24 5.24.0 006.996 3.141c.625-.262 1.184-.641 1.666-1.122s.859-1.041 1.122-1.666c.272-.647.412-1.331.412-2.037s-.137-1.394-.412-2.037c-.262-.625-.641-1.184-1.122-1.666s-1.041-.859-1.666-1.122A5.226 5.226.0 008.912 3.59c-.716.0-1.431.144-2.066.413-.509.216-1.372.769-1.875 1.291l-.003.003V.984h7.241c.262-.003.262-.372.262-.491.0-.122.0-.487-.266-.491H4.377a.343.343.0 00-.344.341v6.066c0 .197.244.338.472.384.444.094.544-.047.653-.197l.016-.019c.166-.247.681-.766.688-.772a4.262 4.262.0 013.037-1.25c1.147.0 2.222.444 3.028 1.25a4.245 4.245.0 011.256 3.019 4.236 4.236.0 01-1.25 3.019 4.336 4.336.0 01-3.047 1.25 4.136 4.136.0 01-2.159-.597l.003-3.688c0-.491.213-1.028.572-1.431a2.09 2.09.0 011.588-.716c.594.0 1.15.225 1.566.634.409.406.637.95.637 1.528A2.179 2.179.0 018.887 11.02c-.238.0-.672-.106-.691-.109-.25-.075-.356.272-.391.387-.134.441.069.528.109.541.397.125.659.147 1.003.147a3.173 3.173.0 003.169-3.169c0-1.734-1.422-3.144-3.166-3.144-.856.0-1.659.328-2.263.919-.575.566-.903 1.319-.903 2.069v.019c-.003.094-.003 2.306-.006 3.031l-.003-.003c-.328-.363-.653-.919-.869-1.488-.084-.222-.275-.184-.534-.103-.125.034-.469.141-.391.394zm3.722-.865c0 .106.097.2.156.253l.019.019c.1.097.194.147.281.147a.181.181.0 00.131-.05c.044-.041.537-.544.588-.591l.553.55c.05.056.106.088.172.088.088.0.184-.053.284-.156.238-.244.119-.375.063-.438l-.559-.559.584-.588c.128-.137.016-.284-.097-.397-.162-.162-.322-.206-.422-.112l-.581.581-.588-.588a.16.16.0 00-.113-.047c-.078.0-.172.053-.275.156-.181.181-.219.306-.125.406l.588.584-.584.584c-.053.05-.078.103-.075.156zm1.278-7.931c-.938.0-1.938.191-2.669.506a.207.207.0 00-.134.181.753.753.0 00.069.337c.047.116.166.425.4.334a6.689 6.689.0 012.334-.444 6.35 6.35.0 012.469.497c.622.263 1.206.644 1.844 1.194a.22.22.0 00.147.059c.125.0.244-.122.347-.237.169-.191.287-.35.119-.509a6.858 6.858.0 00-2.1-1.356 7.326 7.326.0 00-2.825-.563zM14.006 13.3c-.113-.113-.209-.178-.294-.203s-.162-.006-.222.053l-.056.056a6.32 6.32.0 01-6.938 1.356 6.336 6.336.0 01-2.013-1.356 6.046 6.046.0 01-1.356-2.012c-.288-.713-.381-1.247-.413-1.422-.003-.016-.006-.028-.006-.037-.041-.206-.231-.222-.503-.178-.112.019-.459.072-.428.319v.006a7.261 7.261.0 002.04 3.994 7.266 7.266.0 0010.288.0l.059-.059c.069-.084.134-.225-.159-.516z"/></g></symbol><symbol id="icon-codepen" viewBox="0 0 16 16"><g><path d="M14.777 5.751l-7-4.667a.5.5.0 00-.555.0l-7 4.667a.501.501.0 00-.223.416v4.667c0 .167.084.323.223.416l7 4.667a.5.5.0 00.554.0l7-4.667a.501.501.0 00.223-.416V6.167a.501.501.0 00-.223-.416zM7.5 10.232 4.901 8.5 7.5 6.768 10.099 8.5 7.5 10.232zM8 5.899V2.434l5.599 3.732L11 7.898l-3-2zm-1 0-3 2-2.599-1.732L7 2.435V5.9zM3.099 8.5 1 9.899V7.101L3.099 8.5zM4 9.101l3 2v3.465l-5.599-3.732L4 9.102zm4 2 3-2 2.599 1.732L8 14.565V11.1zM11.901 8.5 14 7.101v2.798L11.901 8.5z"/></g></symbol><symbol id="icon-dribbble" viewBox="0 0 16 16"><g><path d="M8 16c-4.412.0-8-3.588-8-8s3.587-8 8-8c4.412.0 8 3.587 8 8s-3.588 8-8 8zm6.747-6.906c-.234-.075-2.116-.634-4.256-.291a29.7 29.7.0 011.328 4.872 6.845 6.845.0 002.928-4.581zM10.669 14.3c-.103-.6-.497-2.688-1.456-5.181-.016.006-.031.009-.044.016-3.856 1.344-5.241 4.016-5.362 4.266a6.807 6.807.0 006.863.9zm-7.747-1.722c.156-.266 2.031-3.369 5.553-4.509a7.04 7.04.0 01.269-.081 24.04 24.04.0 00-.553-1.159c-3.409 1.022-6.722.978-7.022.975-.003.069-.003.138-.003.209.0 1.753.666 3.356 1.756 4.566zM1.313 6.609c.306.003 3.122.016 6.319-.831A43.092 43.092.0 005.098 1.825 6.854 6.854.0 001.314 6.609zM6.4 1.366a36.612 36.612.0 012.55 4c2.431-.909 3.459-2.294 3.581-2.469A6.799 6.799.0 006.4 1.366zm6.891 2.325c-.144.194-1.291 1.663-3.816 2.694.159.325.313.656.453.991.05.119.1.234.147.353 2.275-.284 4.534.172 4.759.219A6.816 6.816.0 0013.29 3.692z"/></g></symbol><symbol id="icon-facebook" viewBox="0 0 16 16"><g><path d="M9.5 3H12V0H9.5C7.57.0 6 1.57 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.271.229-.5.5-.5z"/></g></symbol><symbol id="icon-feed" viewBox="0 0 16 16"><g><path d="M2.13 11.733c-1.175.0-2.13.958-2.13 2.126.0 1.174.955 2.122 2.13 2.122a2.126 2.126.0 002.133-2.122A2.133 2.133.0 002.13 11.733zM.002 5.436v3.067c1.997.0 3.874.781 5.288 2.196a7.45 7.45.0 012.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006.0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824.0.006.0z"/></g></symbol><symbol id="icon-flickr" viewBox="0 0 16 16"><g><path d="M0 8.5a3.5 3.5.0 117 0 3.5 3.5.0 01-7 0zm9 0a3.5 3.5.0 117 0 3.5 3.5.0 01-7 0z"/></g></symbol><symbol id="icon-github" viewBox="0 0 16 16"><g><path d="M8 .198A8 8 0 005.471 15.789c.4.074.547-.174.547-.385.0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954.0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117.0.0.672-.215 2.201.82A7.672 7.672.0 018 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147.0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481.0 1.07-.009 1.932-.009 2.195.0.213.144.462.55.384A8 8 0 008.001.196z"/></g></symbol><symbol id="icon-gitlab" viewBox="0 0 28 28"><g><path d="M1.625 11.031 14 26.89.437 17.046a1.092 1.092.0 01-.391-1.203l1.578-4.813zm7.219.0h10.313L14.001 26.89zM5.75 1.469l3.094 9.562H1.625l3.094-9.562a.548.548.0 011.031.0zm20.625 9.562 1.578 4.813a1.09 1.09.0 01-.391 1.203l-13.563 9.844 12.375-15.859zm0 0h-7.219l3.094-9.562a.548.548.0 011.031.0z"/></g></symbol><symbol id="icon-google-plus" viewBox="0 0 16 16"><g><path d="M5.091 7.147v1.747h2.888c-.116.75-.872 2.197-2.888 2.197-1.737.0-3.156-1.441-3.156-3.216s1.419-3.216 3.156-3.216c.991.0 1.65.422 2.028.784L8.5 4.112c-.888-.828-2.037-1.331-3.409-1.331C2.275 2.784.0 5.059.0 7.875s2.275 5.091 5.091 5.091c2.937.0 4.888-2.066 4.888-4.975.0-.334-.037-.591-.081-.844H5.092zM16 7h-1.5V5.5H13V7h-1.5v1.5H13V10h1.5V8.5H16z"/></g></symbol><symbol id="icon-instagram" viewBox="0 0 22 22"><g><path d="M15.445.0H6.554A6.559 6.559.0 000 6.554v8.891A6.559 6.559.0 006.554 22h8.891a6.56 6.56.0 006.554-6.555V6.554A6.557 6.557.0 0015.445.0zm4.342 15.445a4.343 4.343.0 01-4.342 4.342H6.554a4.341 4.341.0 01-4.341-4.342V6.554a4.34 4.34.0 014.341-4.341h8.891a4.342 4.342.0 014.341 4.341l.001 8.891z"/><path d="M11 5.312A5.693 5.693.0 005.312 11 5.694 5.694.0 0011 16.688 5.694 5.694.0 0016.688 11 5.693 5.693.0 0011 5.312zm0 9.163a3.475 3.475.0 11-.001-6.95 3.475 3.475.0 01.001 6.95zm5.7-10.484a1.363 1.363.0 11-1.364 1.364c0-.752.51-1.364 1.364-1.364z"/></g></symbol><symbol id="icon-linkedin" viewBox="0 0 16 16"><g><path d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502.0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5A1.5 1.5.0 11.999 3.499 1.5 1.5.0 014 3.5z"/></g></symbol><symbol id="icon-mail" viewBox="0 0 22 18"><g><path fill="#000" d="M0 17.225V.776h22v16.447H0v.002zm3.011-1.815h15.978l-5.111-5.115L11 13.179l-2.877-2.883-5.112 5.114zm-1.216-1.275 5.077-5.09L1.795 3.98v10.155zm13.332-5.09 5.079 5.09V3.979l-5.079 5.066zm-4.126 1.588 8.022-8.027-16.045-.001 8.023 8.028z"/></g></symbol><symbol id="icon-medium" viewBox="0 0 24 24"><g><path d="M22.085 4.733 24 2.901V2.5h-6.634l-4.728 11.768L7.259 2.5H.303v.401L2.54 5.594c.218.199.332.49.303.783V16.96c.069.381-.055.773-.323 1.05L0 21.064v.396h7.145v-.401l-2.52-3.049a1.244 1.244.0 01-.347-1.05V7.806l6.272 13.659h.729l5.393-13.659v10.881c0 .287.0.346-.188.534l-1.94 1.877v.402h9.412v-.401l-1.87-1.831a.556.556.0 01-.214-.534V5.267a.554.554.0 01.213-.534z"/></g></symbol><symbol id="icon-npm" viewBox="0 0 16 16"><g><path d="M0 0v16h16V0H0zm13 13h-2V5H8v8H3V3h10v10z"/></g></symbol><symbol id="icon-pinterest" viewBox="0 0 16 16"><g><path d="M8 1.069A6.93 6.93.0 005.475 14.453c-.059-.547-.116-1.391.025-1.988.125-.541.813-3.444.813-3.444s-.206-.416-.206-1.028c0-.963.559-1.684 1.253-1.684.591.0.878.444.878.975.0.594-.378 1.484-.575 2.306-.166.691.344 1.253 1.025 1.253 1.231.0 2.178-1.3 2.178-3.175.0-1.659-1.194-2.819-2.894-2.819-1.972.0-3.128 1.478-3.128 3.009.0.597.228 1.234.516 1.581.056.069.066.128.047.2a95.89 95.89.0 01-.194.787c-.031.128-.1.153-.231.094-.866-.403-1.406-1.669-1.406-2.684.0-2.188 1.587-4.194 4.578-4.194 2.403.0 4.272 1.712 4.272 4.003.0 2.388-1.506 4.313-3.597 4.313-.703.0-1.362-.366-1.588-.797.0.0-.347 1.322-.431 1.647-.156.603-.578 1.356-.862 1.816a6.93 6.93.0 008.984-6.622A6.931 6.931.0 008.001 1.068z"/></g></symbol><symbol id="icon-search" viewBox="0 0 16 16"><g><path d="M15.504 13.616l-3.79-3.223c-.392-.353-.811-.514-1.149-.499a6 6 0 10-.672.672c-.016.338.146.757.499 1.149l3.223 3.79c.552.613 1.453.665 2.003.115s.498-1.452-.115-2.003zM6 10a4 4 0 110-8 4 4 0 010 8z"/></g></symbol><symbol id="icon-strava" viewBox="0 0 24 24"><g><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599 2.836 5.598h4.172L10.463.0l-7 13.828h4.169"/></g></symbol><symbol id="icon-tumblr" viewBox="0 0 16 16"><g><path d="M9.001 7v3.659c0 .928-.012 1.463.086 1.727.098.262.342.534.609.691.354.212.758.318 1.214.318.81.0 1.289-.107 2.09-.633v2.405a9.089 9.089.0 01-1.833.639A7.93 7.93.0 019.369 16a4.9 4.9.0 01-1.725-.276 4.195 4.195.0 01-1.438-.79c-.398-.343-.672-.706-.826-1.091s-.23-.944-.23-1.676V6.556H3.003V4.29c.628-.204 1.331-.497 1.778-.877a4.386 4.386.0 001.08-1.374C6.133 1.505 6.32.825 6.422.0h2.579v4H13v3H9.001z"/></g></symbol><symbol id="icon-twitter" viewBox="0 0 16 16"><g><path d="M16 3.538a6.461 6.461.0 01-1.884.516 3.301 3.301.0 001.444-1.816 6.607 6.607.0 01-2.084.797 3.28 3.28.0 00-2.397-1.034A3.28 3.28.0 007.882 6.029 9.321 9.321.0 011.116 2.598a3.284 3.284.0 001.015 4.381A3.301 3.301.0 01.643 6.57v.041A3.283 3.283.0 003.277 9.83a3.291 3.291.0 01-1.485.057 3.293 3.293.0 003.066 2.281 6.586 6.586.0 01-4.862 1.359 9.286 9.286.0 005.034 1.475c6.037.0 9.341-5.003 9.341-9.341.0-.144-.003-.284-.009-.425a6.59 6.59.0 001.637-1.697z"/></g></symbol><symbol id="icon-vimeo" viewBox="0 0 16 16"><g><path d="M15.994 4.281c-.072 1.556-1.159 3.691-3.263 6.397-2.175 2.825-4.016 4.241-5.522 4.241-.931.0-1.722-.859-2.366-2.581-.431-1.578-.859-3.156-1.291-4.734-.478-1.722-.991-2.581-1.541-2.581-.119.0-.538.253-1.256.753l-.753-.969c.791-.694 1.569-1.388 2.334-2.081 1.053-.909 1.844-1.387 2.372-1.438 1.244-.119 2.013.731 2.3 2.553.309 1.966.525 3.188.647 3.666.359 1.631.753 2.447 1.184 2.447.334.0.838-.528 1.509-1.588.669-1.056 1.028-1.862 1.078-2.416.097-.912-.262-1.372-1.078-1.372a2.98 2.98.0 00-1.184.263c.787-2.575 2.287-3.825 4.506-3.753 1.641.044 2.416 1.109 2.322 3.194z"/></g></symbol><symbol id="icon-wordpress" viewBox="0 0 16 16"><g><path d="M2 8c0 2.313 1.38 4.312 3.382 5.259L2.52 5.622A5.693 5.693.0 002 8zm10.05-.295c0-.722-.266-1.222-.495-1.612-.304-.482-.589-.889-.589-1.371.0-.537.418-1.037 1.008-1.037.027.0.052.003.078.005A6.064 6.064.0 008 2.156 6.036 6.036.0 002.987 4.79c.141.004.274.007.386.007.627.0 1.599-.074 1.599-.074.323-.018.361.444.038.482.0.0-.325.037-.687.055l2.185 6.33 1.313-3.835-.935-2.495a12.304 12.304.0 01-.629-.055c-.323-.019-.285-.5.038-.482.0.0.991.074 1.58.074.627.0 1.599-.074 1.599-.074.323-.018.362.444.038.482.0.0-.326.037-.687.055l2.168 6.282.599-1.947c.259-.809.457-1.389.457-1.889zm-3.945.806-1.8 5.095a6.148 6.148.0 003.687-.093.52.52.0 01-.043-.081L8.105 8.511zm5.16-3.315c.026.186.04.386.04.601.0.593-.114 1.259-.456 2.093l-1.833 5.16c1.784-1.013 2.983-2.895 2.983-5.051a5.697 5.697.0 00-.735-2.803zM8 0a8 8 0 100 16A8 8 0 008 0zm0 15A7 7 0 118 1a7 7 0 010 14z"/></g></symbol><symbol id="icon-youtube" viewBox="0 0 16 16"><g><path d="M15.841 4.8s-.156-1.103-.637-1.587c-.609-.637-1.291-.641-1.603-.678-2.237-.163-5.597-.163-5.597-.163h-.006s-3.359.0-5.597.163c-.313.038-.994.041-1.603.678C.317 3.697.164 4.8.164 4.8S.005 6.094.005 7.391v1.213c0 1.294.159 2.591.159 2.591s.156 1.103.634 1.588c.609.637 1.409.616 1.766.684 1.281.122 5.441.159 5.441.159s3.363-.006 5.6-.166c.313-.037.994-.041 1.603-.678.481-.484.637-1.588.637-1.588s.159-1.294.159-2.591V7.39c-.003-1.294-.162-2.591-.162-2.591zm-9.494 5.275V5.578l4.322 2.256-4.322 2.241z"/></g></symbol></svg><header class=l-header><p class="c-title p-title"><a href=https://akarasz.me/ class=p-title__link>akarasz.me</a></p></header><main id=main class=l-main><article class=p-article><header><h1>Working with DynamoDB</h1><div><div class=c-time>Posted on
<time datetime=2021-03-16T19:21:00+01:00>Mar 16, 2021</time></div></div></header><section id=js-article class=p-article__body><p>In the previous piece we redesigned the <code>store</code> interface for the backend in
hope to have a better DynamoDB implementation to it. After the changes we have
to provide a <code>Load</code> method that returns our <code>Session</code> object with the current
version of it, and a <code>Save</code> method that will get the ID, the modified <code>Session</code>
object and the (assumably) current version that matches the one we still have in
the database; if the provided version does not match the current version, the
method should return an <code>ErrVersionMismatch</code> error.</p><p>Originally I was planning to have the content of this post together with the
previous one but while in the making I realized it was getting too long for a
single post. On the flip side, now that the post was splitted in two, I have
the chance to show some things in more details that I originally planned 🎉!</p><p><em>This item is the sixth one of a series called
<a href=https://akarasz.me/series/pajthy-to-aws/>Pajthy to AWS</a> where I try to capture the
process of migrating one of my open-source pet projects into a serverless setup
in AWS.</em></p><h2 id=about-dynamodb>About DynamoDB</h2><p>DynamoDB is a key-value database provided by AWS, with all the glitter we
could expect from the go-to NoSQL solution of one of the largest cloud service
providers: it&rsquo;s fast, flexible, can work as a multi-region database and these
are just some of the qualities that Amazon uses to describe their service
🤭.</p><p>The value part of an entry could be practically anything we could write
into a JSON: other than the common primitives it supports arrays and maps as
well. It&rsquo;s important to note that it&rsquo;s not storing JSON objects, though it is
pretty similar to it; like a JSON with type definitions.</p><p>We can define a schema for our data beforehand, but we can extend an entry with
different attributes later without any schema changes if we want. The <em>key</em> is
part of the data, so at least that is what we have to define when we create the
table.</p><h3 id=condition-expressions>Condition expressions</h3><p>In the <a href=https://akarasz.me/2021/03/optimistic-locking/>Optimistic locking</a> post we saw that
for optimistic locking to work we need an atomic operation that can check a
given condition and then either save the data or return with an error regarding
the result of that condition. DynamoDB supports <a href=https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.ConditionExpressions.html>condition expressions</a>,
we can utilize for our use.</p><p>The condition in our case is: when there is no version supplied with the session
object to <code>Save</code>, we want to have the <code>attribute_not_exists(SessionID)</code>
expression. If we have the version then what we will check is
<code>version = :last_known</code>; by having these expressions the <a href=https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_PutItem.html>PutItem</a>
operation will fail with a <code>ConditionalCheckFailedException</code>: that&rsquo;s something
we can look for in our responses.</p><h3 id=the-go-sdk>The go SDK</h3><p>AWS maintains an official SDK for go, and in it has some nice helpers that we
can use to make our life easier; for example an (entity mapper)[https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/feature/dynamodb/attributevalue]
that will do the marshaling between the DynamoDB syntax and go structs.</p><p><em>If you look for code examples for the go AWS SDK on the web then always check
the SDK version; v1 and v2 are pretty similar, but it can be a pain to
&ldquo;normalize&rdquo; the code of mixed versions if you build your proof of concept out
of snippets from different sources.</em></p><h2 id=store-implementation>Store implementation</h2><p>As I mentioned earlier, the data we push into Dynamo needs to include the key.
For achieving it we can create a composite struct from the current
<code>store.Session</code> item and the key itself:</p><p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>dynamoKey</span> <span style=color:#66d9ef>struct</span> {
  <span style=color:#a6e22e>SessionID</span> <span style=color:#66d9ef>string</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newDynamoKey</span>(<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>dynamoKey</span> {
  <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dynamoKey</span>{
    <span style=color:#a6e22e>SessionID</span>: <span style=color:#a6e22e>id</span>,
  }
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>dynamoItem</span> <span style=color:#66d9ef>struct</span> {
  <span style=color:#f92672>*</span><span style=color:#a6e22e>dynamoKey</span>
  <span style=color:#f92672>*</span><span style=color:#a6e22e>Session</span>
}
</code></pre></td></tr></table></div></div><a href=https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo.go#L30>https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo.go#L30</a></p><p>From now on, when we save or load items in DynamoDB, we&rsquo;ll doing so by using
these <code>dynamoItem</code> objects.</p><p>To produce the condition expression we have the following method:</p><p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dynamoCondition</span>(<span style=color:#a6e22e>version</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>uuid</span>.<span style=color:#a6e22e>UUID</span>) <span style=color:#a6e22e>expression</span>.<span style=color:#a6e22e>ConditionBuilder</span> {
  <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>version</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>expression</span>.<span style=color:#a6e22e>AttributeNotExists</span>(<span style=color:#a6e22e>expression</span>.<span style=color:#a6e22e>Name</span>(<span style=color:#e6db74>&#34;SessionID&#34;</span>))
  }

  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>expression</span>.<span style=color:#a6e22e>Equal</span>(
    <span style=color:#a6e22e>expression</span>.<span style=color:#a6e22e>Name</span>(<span style=color:#e6db74>&#34;Version&#34;</span>),
    <span style=color:#a6e22e>expression</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>version</span>[<span style=color:#ae81ff>0</span>]))
}
</code></pre></td></tr></table></div></div><a href=https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo.go#L122>https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo.go#L122</a></p><p>Based on the <code>version</code> parameter of the method:</p><ul><li>if there was no version specified it means the item we want to put is a new
one (otherwise we&rsquo;d provide a version 🧠), so in <strong>line 124</strong> we return
a condition that fails if the <code>SessionID</code> attribute not exists in the item;
since this attribute is a mandatory one (it&rsquo;s the key after all) the lack of
it must mean that there is no session either.</li><li>if we had a version we return the version equality check in <strong>line 127</strong>.</li></ul><p>The actual <code>Save</code> looks like this now:</p><p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>attributevalue</span>.<span style=color:#a6e22e>MarshalMap</span>(<span style=color:#a6e22e>newDynamoItem</span>(<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>WithNewVersion</span>(<span style=color:#a6e22e>item</span>)))
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
}

<span style=color:#a6e22e>expr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>expression</span>.<span style=color:#a6e22e>NewBuilder</span>().
  <span style=color:#a6e22e>WithCondition</span>(<span style=color:#a6e22e>dynamoCondition</span>(<span style=color:#a6e22e>version</span><span style=color:#f92672>...</span>)).
  <span style=color:#a6e22e>Build</span>()
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
}

<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dynamodb</span>.<span style=color:#a6e22e>PutItemInput</span>{
  <span style=color:#a6e22e>TableName</span>:                 <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>table</span>,
  <span style=color:#a6e22e>Item</span>:                      <span style=color:#a6e22e>data</span>,
  <span style=color:#a6e22e>ConditionExpression</span>:       <span style=color:#a6e22e>expr</span>.<span style=color:#a6e22e>Condition</span>(),
  <span style=color:#a6e22e>ExpressionAttributeNames</span>:  <span style=color:#a6e22e>expr</span>.<span style=color:#a6e22e>Names</span>(),
  <span style=color:#a6e22e>ExpressionAttributeValues</span>: <span style=color:#a6e22e>expr</span>.<span style=color:#a6e22e>Values</span>(),
}
</code></pre></td></tr></table></div></div><a href=https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo.go#L89>https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo.go#L89</a></p><p>First, starting at <strong>line 89</strong> we have our <code>dynamoItem</code> struct - with a new
random version - marshaled into the DynamoDB format; we could&rsquo;ve done this by
hand as well, in that case we have to define the data types for all of the
attributes, then convert all non-pointer variables to pointers, since that&rsquo;s
what the SDK expects. Better use the the <a href=https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/feature/dynamodb/attributevalue#MarshalMap><code>MarshalMap</code></a>
if you ask me 😅.</p><p>In <strong>line 94</strong> there is another <a href=https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/feature/dynamodb/expression>helper</a>
for building the condition: we&rsquo;ll have to provide attribute names and values
separately with out condition; by using this builder we can just throw
conditions in and it will spit out the values we need in the call in
<strong>lines 104-106</strong>.</p><p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>PutItem</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#a6e22e>req</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>ccfe</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>ConditionalCheckFailedException</span>
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>As</span>(<span style=color:#a6e22e>err</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ccfe</span>) {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrVersionMismatch</span>
  }

  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
}

<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</code></pre></td></tr></table></div></div><a href=https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo.go#L109>https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo.go#L109</a></p><p>Based on the error <code>PutItem</code> returned we either</p><ul><li>return <code>ErrVersionMismatch</code> at <strong>line 113</strong> if the conditional check was
what failed</li><li>return the error as is if was some other error</li><li>or return <code>nil</code> if the operation was successful.</li></ul><h3 id=testing>Testing</h3><p>When testing edge layers (like <code>store</code>), where the component directly
communicates with an external service, I like to test with with an actual
instance of that service instead of mocking it. In our case we could have
a user in a test account and test the behavior directly on a DynamoDB
table running in AWS; however this would make it difficult for others to easily
test the changes (I won&rsquo;t share my AWS credentials for sure) and don&rsquo;t forget
about the financial aspect either: we are paying for executed operations here
after all.</p><p>Luckily Amazon provides a way to run a DynamoDB instance locally in a Docker
container (for testing purposes), and with a container we are golden; we can
spin up an instance easily with <a href=https://pkg.go.dev/github.com/testcontainers/testcontainers-go><code>testcontainers</code></a>:</p><p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>container</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>testcontainers</span>.<span style=color:#a6e22e>GenericContainer</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>testcontainers</span>.<span style=color:#a6e22e>GenericContainerRequest</span>{
  <span style=color:#a6e22e>ContainerRequest</span>: <span style=color:#a6e22e>testcontainers</span>.<span style=color:#a6e22e>ContainerRequest</span>{
    <span style=color:#a6e22e>Image</span>:        <span style=color:#e6db74>&#34;amazon/dynamodb-local:latest&#34;</span>,
    <span style=color:#a6e22e>ExposedPorts</span>: []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;8000/tcp&#34;</span>},
    <span style=color:#a6e22e>WaitingFor</span>:   <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>ForListeningPort</span>(<span style=color:#e6db74>&#34;8000/tcp&#34;</span>),
  },
  <span style=color:#a6e22e>Started</span>: <span style=color:#66d9ef>true</span>,
})
<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Terminate</span>(<span style=color:#a6e22e>ctx</span>)

<span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Host</span>(<span style=color:#a6e22e>ctx</span>)
<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
<span style=color:#a6e22e>port</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>MappedPort</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;8000&#34;</span>)
<span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)

<span style=color:#a6e22e>customResolver</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>EndpointResolverFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>region</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>Endpoint</span>, <span style=color:#66d9ef>error</span>) {
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>service</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>dynamodb</span>.<span style=color:#a6e22e>ServiceID</span> {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>Endpoint</span>{
      <span style=color:#a6e22e>PartitionID</span>:   <span style=color:#e6db74>&#34;aws&#34;</span>,
      <span style=color:#a6e22e>URL</span>:           <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;http://%s:%s&#34;</span>, <span style=color:#a6e22e>ip</span>, <span style=color:#a6e22e>port</span>.<span style=color:#a6e22e>Port</span>()),
      <span style=color:#a6e22e>SigningRegion</span>: <span style=color:#a6e22e>region</span>,
    }, <span style=color:#66d9ef>nil</span>
  }
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>Endpoint</span>{}, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unknown endpoint requested&#34;</span>)
})

<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LoadDefaultConfig</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>WithEndpointResolver</span>(<span style=color:#a6e22e>customResolver</span>))
</code></pre></td></tr></table></div></div><a href=https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo_test.go#L27>https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo_test.go#L27</a></p><p>We initialize the test by starting the <code>testcontainer</code>; in <strong>lines 27-36</strong> we
define the name of the image (using the latest version, we&rsquo;ll use that in AWS as
well after all), the ports we want to expose and a condition: execution will
wait until the condition gets accomplished. Once the container is up and running
(and it&rsquo;s 8000/tcp is available) we extract the host and port from the
container: based on where we run our test (on our machine? in a docker
container? in a docker on another machine?) and to which port <code>testcontainer</code>
map the service these values can vary by each execution.</p><p>We have to tell the SDK as well that it should not go out to the cloud for the
test table. In <strong>line 43-52</strong> we define a new endpoint resolver: if the service
the SDK wants to go is a DynamoDB it should go directly to our container.</p><p>Now that we have the infrastructure and the configuration set up, let&rsquo;s see
the table we&rsquo;ll run our tests in:</p><p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CreateTable</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dynamodb</span>.<span style=color:#a6e22e>CreateTableInput</span>{
  <span style=color:#a6e22e>TableName</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;testPajthy&#34;</span>),
  <span style=color:#a6e22e>AttributeDefinitions</span>: []<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>AttributeDefinition</span>{
    {
      <span style=color:#a6e22e>AttributeName</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;SessionID&#34;</span>),
      <span style=color:#a6e22e>AttributeType</span>: <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>ScalarAttributeTypeS</span>,
    },
  },
  <span style=color:#a6e22e>KeySchema</span>: []<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>KeySchemaElement</span>{
    {
      <span style=color:#a6e22e>AttributeName</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;SessionID&#34;</span>),
      <span style=color:#a6e22e>KeyType</span>:       <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>KeyTypeHash</span>,
    },
  },
  <span style=color:#a6e22e>ProvisionedThroughput</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>ProvisionedThroughput</span>{
    <span style=color:#a6e22e>ReadCapacityUnits</span>:  <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>Int64</span>(<span style=color:#ae81ff>5</span>),
    <span style=color:#a6e22e>WriteCapacityUnits</span>: <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>Int64</span>(<span style=color:#ae81ff>5</span>),
  },
})
</code></pre></td></tr></table></div></div><a href=https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo_test.go#L59>https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/store/dynamo_test.go#L59</a></p><p>With these in place we can run the <code>store</code> test suite against the DynamoDB
implementation.</p><h3 id=finishing-touches>Finishing touches</h3><p>The only thing remains is to wire in <code>DynamoDB</code> store instead of the <code>InMemory</code>
one into the Lambda:</p><p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LoadDefaultConfig</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>())
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
}

<span style=color:#a6e22e>h</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>NewDynamoDB</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;DYNAMO_TABLE_NAME&#34;</span>)), <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>New</span>())
</code></pre></td></tr></table></div></div><a href=https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/cmd/lambda/main.go#L57>https://github.com/akarasz/pajthy-backend/blob/b14fd34ce8891a17a5f8b53dbf87ea612c19c2c1/cmd/lambda/main.go#L57</a></p><p>The <a href=https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/config#LoadDefaultConfig><code>LoadDefaultConfig</code></a>
method is an awesome help for dealing with the configuration. By default it
will look for authentication parameters in environment variables (these are set
when running in Lambda). If it did not find those, it will fall back to the
<code>~/.aws/config</code> and <code>~/.aws/credentials</code> files; that could come handy when
running the code on the machine you use <code>aws cli</code> too.</p><p>Build it, deploy it, see it working!</p><p><img src=https://media.giphy.com/media/VdiQKDAguhDSi37gn1/giphy.gif alt="it&amp;rsquo;s alive! from ace ventura"></p><h2 id=first-impressions>First impressions</h2><p>After some testing on AWS I noticed that the first execution for a fresh
Lambda container now could take up to one - one and a half second. This delay
could be an issue with a &ldquo;real time&rdquo; service like <em>Pajthy</em> is. For now I let it
be: our goal in this series is to migrate the service, not to make it perfect;
after all we can always configure some <a href=https://aws.amazon.com/blogs/aws/new-provisioned-concurrency-for-lambda-functions/>provisioned concurrency</a>
to have enough containers always running that would deal with the majority of
the load. With a running container Lambda execution times usually stay under
100ms.</p><h2 id=conclusion>Conclusion</h2><p>With this we are finished with the store layer! In this post we went through</p><ul><li>what is DynamoDB in a nutshell</li><li>how does DynamoDB provide the functions we need for our
<a href=https://akarasz.me/2021/03/optimistic-locking/>Optimistic locking</a> setup</li><li>how to access these functions with the go AWS SDK v2 and what additional
goodies the library have to make our life easier</li><li>how to test DynamoDB with a local docker container.</li></ul><p>In the next post we&rsquo;ll find a way to deal with the WebSocket events that make
<em>pajthy</em> the interactive wonder that makes it actually useful!</p></section><footer><nav class="p-pagination c-pagination"><div class=c-pagination__ctrl><div class=c-pagination__newer><a href=https://akarasz.me/2021/04/postgresql-unique-constraint-on-joined-tables/>Newer</a></div><div class=c-pagination__older><a href=https://akarasz.me/2021/03/optimistic-locking/>Older</a></div></div></nav></footer></article></main><footer class=l-footer><p class=p-copyright>&nbsp;&bull;&nbsp;
2021
&nbsp;&bull;&nbsp;
<a href=https://akarasz.me/>akarasz.me</a></p></footer></body></html>